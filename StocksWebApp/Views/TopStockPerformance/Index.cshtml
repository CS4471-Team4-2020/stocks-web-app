@{
    ViewData["Title"] = "Top Stock Performer";
}
@model TopStockPerformanceViewModel
<link rel="stylesheet" type="text/css" href="~/css/chartist-plugin-tooltip.css" />
<link rel="stylesheet" href="~/css/chartist.min.css" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/resources/demos/style.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="~/js/chartist.min.js"></script>
<script src="~/js/chartist-plugin-tooltip.js"></script>

<style>
    .header {
        display: inline-block;
        background-image: url('/images/banner5.jpg');
        width: 100%;
        height: 200px;
        background-size: cover;
        margin-bottom: 15px;
        box-shadow: 0px 5px 5px 0px #ccc;
    }

        .header h1 {
            background-color: rgb(255, 255, 255, 0.5);
            padding: 5px;
            padding-left: 20px;
            margin-top: 140px;
            text-shadow: 2px 2px 2px rgba(0,0,0,0.3);
        }
</style>

<div class="row">
    <div class="header">
        <h1>@ViewData["Title"]</h1>
    </div>

</div>

@*Populate the company selector*@
<div>
    <select id="kpiSelect">
        @foreach (var kpiKey in Model.kpiDict.Keys)
        {
            <option value="@kpiKey">@Model.kpiDict[kpiKey]</option>
        }
    </select>
</div>

@*Buttons for choosing date range*@
<div>
    <button type="button" class="date-button" value="0">1 Day</button>
    <button type="button" class="date-button" value="1">1 Month</button>
    <button type="button" class="date-button" value="2">3 Months</button>
    <button type="button" class="date-button" value="3">6 Months</button>
    <button type="button" class="date-button" value="4">1 Year</button>
    @*Choose own date range*@
    <span>Custom Range</span>
    <input type="text" class="date-pick" id="startDate" />
    <input type="text" class="date-pick" id="endDate" />
    <button type="button" class="date-button" value="5">Submit</button>
</div>

@*Div that contains the table*@
<div class="ct-chart" style="position:relative;"></div>
<div class="row">
    <div class="panel-group" id="accordion">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">
                        Highest Closing Price
                    </a>
                </h4>
            </div>
            <div id="collapse1" class="panel-collapse collapse in">
                <div class="panel-body">
                    <table class="table table-hover">
                        <tbody>
                            <tr>
                                <th scope="row"></th>
                                <th>Company Abbreviation</th>
                                <th>Company Name</th>
                                <th>Price</th>
                            </tr>
                            @*Table Entry*@
                            <tr>
                                <td scope="row">1</td>
                                <td>ctcm</td>
                                <td>CTC Media Inc</td>
                                <td>1.00</td>
                            </tr>
                        </tbody>
                    </table>

                </div>
            </div>
        </div>
    </div>
</div>


<script>
    //Updates the table with the new data
    function refreshTable(kpi, startDate, endDate) {
        var reqData = { Kpi: kpi, StartDate: dateString(startDate), EndDate: dateString(endDate) }
        //Make POST request to controller to get new data
        $.ajax({
        type: "POST",
            url: "/TopStockPerformance/Update",
            data: reqData,
            success: function (response) {
                var dates = response.dates;
                var prices = response.prices;
                var newData = { labels: dates, series: [prices] };
                var newoptions = {
                    width: '100%',
                    height: 400,
                    axisX: {
                        labelInterpolationFnc: function skipLabels(value, index) {
                        return index % 2 === 0 ? value : null;
                        }
                    }
                };

                //Empty chart and create new one
                $('.ct-chart').empty();
                new Chartist.Line('.ct-chart', newData, newoptions);

        }
    });
    }

    //Format Date object as string
    function dateString(date) {
        var day = date.getDate().toString().padStart(2,'0');       // yields date
        var month = date.getMonth() + 1;
        month = month.toString().padStart(2, '0');// yields month (add one as '.getMonth()' is zero indexed)
        var year = date.getFullYear();  // yields year
        var hour = date.getHours().toString().padStart(2,'0');     // yields hours
        var minute = date.getMinutes().toString().padStart(2,'0'); // yields minutes
        var second = date.getSeconds().toString().padStart(2,'0'); // yields seconds

        // After this construct a string with the above results as below
        var time = day + "/" + month + "/" + year + " " + hour + ':' + minute + ':' + second;
        return time;
    }

    //Initialize datepicker listener
    $('.date-pick').datepicker({ changeMonth: true, changeYear: true });

    //Initialize kpi select listener
    $("#kpiSelect").change(function () {
        //After changing kpi, update the table displaying top 10 performers
        var startDate = new Date(2011, 0, 13);
        var endDate = new Date(2011, 0, 13, 23, 59, 59);
        var kpi = $('#kpiSelect').val();
        refreshTable(kpi, startDate, endDate);
    });

    //Initialize daterange button listener
    $('.date-button').on("click", function ()
    {
        //Default start date except for custom date range
        var startDate = new Date(2011, 0, 13);
        var endDate;

        var valu = parseInt($(this).val());
        switch (valu)
        {
            //1 day range
            case 0:
                endDate = new Date(2011, 0, 13, 23, 59, 59);
                break;
            //1 month range
            case 1:
                endDate = new Date(2011, 1, 13, 23, 59, 59);
                break;
            //3 month range
            case 2:
                endDate = new Date(2011, 3, 13, 23, 59, 59);
                break;
            //6 month range
            case 3:
                endDate = new Date(2011, 6, 13, 23, 59, 59);
                break;
            //1 year range
            case 4:
                endDate = new Date(2011, 11, 13, 23, 59, 59);
                break;
            //Custom range
            case 5:
                var startDateNums = $('#startDate').val().split('/');
                startDate = new Date(startDateNums[2], startDateNums[0]-1, startDateNums[1], 0, 0, 0);
                var endDateNums = $('#endDate').val().split('/');
                endDate = new Date(endDateNums[2], endDateNums[0]-1, endDateNums[1], 23, 59, 59);
                break;

        };
        var company = $('#kpiSelect').val();
        refreshTable(kpi, startDate, endDate);
    });

    //Create table on initial page load (From Daniel)

    var labelData = [];
    var seriesData = [];
    @foreach (var label in Model.Dates)
    {
        @:labelData.push("@label");
    }
    @foreach (var price in Model.Prices)
    {
        @:seriesData.push("@price");
    }
    console.log(labelData);
    var data = {
        labels: labelData,

        series: [
            seriesData
        ]
    };


</script>